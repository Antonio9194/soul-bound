<div class="row justify-content-center g-5">

  <!-- Character Card Column -->
  <div class="col-md-6 col-lg-5">
    <!-- Character Card -->
    <div class="card h-100 p-3 mt-3 shadow rounded-4 border border-2 border-warning" style="background: #fff3e0; color: black;">

      <!-- Character Name Header -->
      <div class="card-header text-center bg-light rounded-3 mb-3" style="border: 1px solid #000;">
        <h1 class="fw-bold" style="font-family: 'Press Start 2P', cursive; font-size: 1.2rem;"><%= @character.name %></h1>
      </div>

      <!-- Character Info Container -->
      <div class="d-flex flex-column align-items-center"
            style="border: 2px solid #000; border-radius: 20px; padding: 40px; background-color: #f9f1e7; position: relative;">

        <!-- Character Sprite Preview Card -->
        <div class="card position-relative mb-3" style="width: 70%; height: 260px; background: transparent; border: none;">
          <!-- Character Sprite Preview -->
          <div id="character-preview"
                style="width: 80px; height: 120px; border: 1px solid gray; border-radius: 5px; background-color: #eaeaea; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); image-rendering: pixelated;">
          </div>

          <% slots = %w[head top bottom weapon accessory] %>
          <% slot_positions = {
                "head" => "bottom: 180px; left: 50%; transform: translateX(-50%);",
                "top" => "bottom: 120px; left: -40px;",
                "bottom" => "bottom: 120px; right: -40px;",
                "weapon" => "bottom: 0; left: -40px;",
                "accessory" => "bottom: 0; right: -40px;"
              } %>

          <% slot_mapping = {
                "head" => ["head"],
                "top" => ["top"],
                "bottom" => ["bottom"],
                "weapon" => ["sword", "staff", "book"],
                "accessory" => ["ring", "amulet", "potion"]
              } %>

          <!-- Equipped Item Slots -->
          <% slots.each do |slot| %>
          <!-- Equipped Items and Unequip button -->
            <div id="slot-<%= slot %>" data-equipment-manager-target="slot" data-slot="<%= slot %>"
                  style="position: absolute; <%= slot_positions[slot] %>; width: 100px; height: 100px; border: 2px solid black; border-radius: 10px; background-color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;">

              <% equipped_item = @character.inventory_items.includes(:item)
                                  .where(equipped: true)
                                  .find { |inv| slot_mapping[slot].any? { |name| inv.item.img.include?(name) } } %>

              <% if equipped_item %>
                <%= image_tag asset_path(equipped_item.item.img),
                    alt: equipped_item.item.name,
                    class: "img-fluid",
                    style: "width: 100%; height: 60%; object-fit: contain; image-rendering: pixelated; padding: 2px; margin: 4px;"
                %>
                <%= button_to "Unequip", unequip_inventory_item_path(equipped_item),
                 method: :patch,
                 style: " width: 100px; border: 1px solid black; border-radius: 0 0 10px 10px;" %>
              <% else %>
                <span style="font-size: 0.7rem; color: #aaa;">Empty</span>
              <% end %>
            </div>
          <% end %>
        </div>

        <!-- Character Level & Stats -->
        <h5 class="fw-bold mb-2" style="font-family: 'Press Start 2P', cursive; font-size: 0.9rem;">Level: <%= @character.level %></h5>
        <div class="d-flex justify-content-between w-100" style="margin-top: 10px;">
          <h5 class="fw-bold" style="font-family: 'Press Start 2P', cursive; font-size: 0.9rem;">Exp: <%= @character.xp %></h5>
          <h5 class="fw-bold" style="font-family: 'Press Start 2P', cursive; font-size: 0.9rem;">Coins: <%= number_with_delimiter(@character.coin, delimiter: ".") %> ðŸ’°</h5>
        </div>
      </div>

      <!-- Character Card Actions (Edit/Delete) -->
      <div class="d-flex justify-content-center mt-3 gap-2">
        <%= link_to "Edit", edit_character_path(@character), class: "btn btn-outline-primary fw-bold rounded-4 flex-fill" %>
        <%= link_to "Delete", @character, data: { turbo_method: :delete, turbo_confirm: 'Are you sure?' }, class: "btn btn-outline-danger fw-bold rounded-4 flex-fill" %>
      </div>
    </div>
  </div>

  <!-- Inventory Card Column -->
  <div class="col-md-6 col-lg-5">
    <!-- Inventory Card -->
    <div class="card h-100 p-3 mt-3 shadow rounded-4 border border-2 border-warning" style="background: #fff3e0; color: black;">
      <!-- Inventory Header -->
      <div class="card-header text-center bg-light rounded-3 mb-3" style="border: 1px solid #000;">
        <h4 class="fw-bold" style="font-family: 'Press Start 2P', cursive; font-size: 1rem;">Inventory</h4>
      </div>

      <!-- Inventory Grid -->
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 20px; background-color: #f9f1e7; border: 2px solid #000; border-radius: 20px; margin: 3px 10px;">
        <% slots_count = @character.slots || 10 %>
        <% inventory_items = @character.inventory_items.includes(:item).where(equipped: false).to_a %>

        <% slots_count.times do |i| %>
          <% inventory_item = inventory_items[i] %>
          <!-- Single Inventory Slot -->
          <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">

            <!-- Item Image -->
            <div style="width: 100px; height: 100px; border: 2px solid black; border-radius: 10px; background-color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;">
               <!-- Equip Button -->
            <div style="text-align: center;">
              <% if inventory_item %>
                <%= button_to "Equip", equip_inventory_item_path(inventory_item),
                 method: :patch,
                 style: "width: 100px; border: 1px solid black; border-radius: 10px 10px 0 0;" 
                 %>
              <% else %>
                <span style="font-size: 0.7rem; color: #aaa;">Empty</span>
              <% end %>
            </div>
              <% if inventory_item %>
              <%= link_to inventory_item_path(inventory_item),
                  style: "display: flex; width: 100%;
                  height: 60%; justify-content: center;
                  align-items: center;" do
              %>
                <%= image_tag inventory_item.item.img,
                    alt: inventory_item.item.name,
                    class: "img-fluid",
                    style: "width: 100%; height: 100%;
                    object-fit: contain; image-rendering: pixelated;
                    padding: 2px; margin: 4px;"
                %>
              <% end %> 
              <% else %>
                <span style="color: #aaa; font-size: 1.2rem;">â€”</span>
              <% end %>
            </div>

            <!-- Sell Button -->
            <div style="text-align: center;">
              <% if inventory_item %>
                <%= button_to "Sell", sell_inventory_item_path(inventory_item), method: :delete, data: { confirm: "Are you sure?" } %>
              <% end %>
            </div>

          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Character Sprite Animation Script -->
<script>
document.addEventListener("turbo:load", () => {
  initSprite();
  });

  function initSprite() {


  const preview = document.getElementById("character-preview");
  const klass = "<%= @character.class_name.downcase %>";
  const gender = "<%= @character.gender.downcase %>";

  const spriteData = {
    "male_warrior": { path: "<%= asset_path('male_warrior.png') %>", frames: 5, frameWidth: 86, frameHeight: 118, offsetX: [0,0,0,0,0], speed: 170 },
    "female_warrior": { path: "<%= asset_path('female_warrior.png') %>", frames: 9, frameWidth: 100, frameHeight: 118, offsetX: [0,0,0,0,0], speed: 170 },
    "male_mage": { path: "<%= asset_path('male_mage.png') %>", frames: 16, frameWidth: 128, frameHeight: 138, offsetX: [0,0,0,0,0], speed: 150 },
    "female_mage": { path: "<%= asset_path('female_mage.png') %>", frames: 10, frameWidth: 128, frameHeight: 138, offsetX: [0,0,0,0,0], speed: 120 },
    "male_werewolf": { path: "<%= asset_path('male_werewolf.png') %>", frames: 7, frameWidth: 128, frameHeight: 138, offsetX: [0,0,0,0,0], speed: 110 },
    "female_werewolf": { path: "<%= asset_path('female_werewolf.png') %>", frames: 11, frameWidth: 128, frameHeight: 138, offsetX: [0,0,0,0,0], speed: 110 },
    "gorgon": { path: "<%= asset_path('gorgon_1.png') %>", frames: 16, frameWidth: 128, frameHeight: 138, offsetX: [0,0,0,0,0], speed: 160 }
  };

  const key = klass === "gorgon" ? "gorgon" : `${gender}_${klass}`;
  const sprite = spriteData[key];
  if (!sprite) return;

    let currentFrame = 0;
  preview.style.width = sprite.frameWidth + "px";
  preview.style.height = sprite.frameHeight + "px";
  preview.style.backgroundImage = `url(${sprite.path})`;
  preview.style.backgroundRepeat = "no-repeat";
  preview.style.backgroundPosition = "0 0";
  preview.style.imageRendering = "pixelated";

  setInterval(() => {
    const xOffset = (sprite.frameWidth * currentFrame) - (sprite.offsetX?.[currentFrame] || 0);
    preview.style.backgroundPosition = `-${xOffset}px 0px`;
    currentFrame = (currentFrame + 1) % sprite.frames;
  }, sprite.speed || 170);


};

</script>
